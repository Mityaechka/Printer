<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="index.js"></script>
    <script type="text/javascript" src="values.js"></script>
    <script type="text/javascript" src="canvas-text-wrapper.js"></script>
</head>

<body>

    <div class="reciept-editor">
        <h1>Настройка чека</h1>
        <div id="labels">
        </div>
        <button id="addLabel" onclick="addLabel()">Добавить</button>
    </div>
    <div id="dragable">
        <div id="canvasHeader">Чек</div>
        <canvas width="400" height="300" id="canvas">
        </canvas>
    </div>
</body>


<script>
    var template;
    const labelPattern = `
        <div class="inline-container">
            <div class="input-area">
                <label >Поле</label>
                <select id="type" onchange="changeAreaType()" onchange="RedrawReciept()">
                    <option value="text">Текст</option>
                    <option value="image">Изображение</option>
                    <option value="indent">Отступ</option>
                    <option value="table">Таблица значений</option>
                    <option value="line">Линия</option>
                    <option value="doubleText">Двойной текст</option>
                    <option value="complexText">Сложное текстовое поле</option>
                </select>
            </div>
        </div>
        <div id="value">

        </div>
        <div>
            <button id="RemoveLabel" onclick="RemoveLabel()">Удалить</button>
            <button id="UpBtn" onclick="LabelUp()">Вверх</button>
            <button id="DownBtn" onclick="LabelDown()">Вниз</button>
        </div>
    `;

    let labelsDiv = document.getElementById("labels");
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");

    function LabelUp() {
        var label = event.target.closest("#label");
        var prev = label.previousElementSibling;
        labels.insertBefore(label, prev);
        CheckUpDown();

        RedrawReciept();
    }
    function LabelDown() {
        var label = event.target.closest("#label");
        var next = label.nextElementSibling;
        labels.insertBefore(label, next.nextElementSibling);
        CheckUpDown();

        RedrawReciept();
    }
    function CheckUpDown() {
        var l = labels.querySelectorAll("#label");
        for (let i = 0; i < l.length; i++) {
            const label = l[i];
            if (l.length == 1) {
                label.querySelector("#UpBtn").setAttribute("hidden", "hidden");
                label.querySelector("#DownBtn").setAttribute("hidden", "hidden");
            } else if (i == 0) {
                label.querySelector("#UpBtn").setAttribute("hidden", "hidden");
                label.querySelector("#DownBtn").removeAttribute("hidden");
            } else if (i == l.length - 1) {
                label.querySelector("#DownBtn").setAttribute("hidden", "hidden");
                label.querySelector("#UpBtn").removeAttribute("hidden");
            } else {
                label.querySelector("#UpBtn").removeAttribute("hidden");
                label.querySelector("#DownBtn").removeAttribute("hidden");
            }

        }
    }
    function changeAreaType(label) {
        if (!label)
            label = event.target.closest("#label");

        var type = label.querySelector("#type");
        var field;
        switch (type.value) {
            case "text":
                field = new TextField();
                break;
            case "doubleText":
                field = new DoubleTextField();
                break;
            case "complexText":
                field = new ComplexTextField();
                break;
            case "image":
                field = new ImageField();
                break;
            case "indent":
                field = new IndentField();
                break;
            case "line":
                field = new LineField();
                break;
            case "table":
                field = new TableField();
                break;
            default:
                field = new Field();
                break;
        }
        field.AddPattern(label.querySelector("#value"));
        field.FillPattern();
        CheckUpDown();
        RedrawReciept();
    }
    function addLabel() {
        var pattern = labelPattern;
        var element = stringToHTML(pattern);

        element.querySelector("#type").value = "table";
        element.setAttribute("id", "label")

        element.setAttribute("class", "label-conatainer")
        labelsDiv.appendChild(element);
        changeAreaType(element);
        CheckUpDown();
        RedrawReciept();
    }
    async function RedrawReciept() {
        var template = [];
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "black";

        var labels = labelsDiv.querySelectorAll("[id^=label]");
        var prevYPos = 0;
        for (let i = 0; i < labels.length; i++) {
            const label = labels[i];
            var type = label.querySelector("#type");
            var valueArea = label.querySelector("#value");
            if (!type)
                return;
            var field = new Field();
            var fieldTemplate ={};
            fieldTemplate.type = type.value;
            switch (type.value) {
                case "text":
                    var options ={
                        align: valueArea.querySelector("#align").value,
                        fontSize: valueArea.querySelector("#fontSize").value,
                        style: valueArea.querySelector("#style").value,
                        text: valueArea.querySelector("#text").value,
                    }
                    fieldTemplate.options = options;
                    field = new TextField(options);
                    break;
                case "doubleText":
                    var options ={
                        fontSize: valueArea.querySelector("#fontSize").value,
                        style: valueArea.querySelector("#style").value,
                        firstText: valueArea.querySelector("#firstText").value,
                        secondText: valueArea.querySelector("#secondText").value
                    };
                    field = new DoubleTextField(options);
                    fieldTemplate.options = options;
                    break;
                case "complexText":
                    var textDivs = valueArea.querySelectorAll("#textField");
                    var texts= [];
                    for (let i = 0; i < textDivs.length; i++) {
                        const textDiv = textDivs[i];
                        texts.push({
                            text:textDiv.querySelector("#text").value,
                            align:textDiv.querySelector("#align").value,
                            style:textDiv.querySelector("#style").value,
                            fontSize:textDiv.querySelector("#fontSize").value,
                            width:textDiv.querySelector("#width").value
                        });
                    }
                    var options = {
                        texts:texts
                    };
                    field = new ComplexTextField(options);
                    fieldTemplate.options = options;
                    break;
                case "image":
                    var img = new Image;
                    img.src = URL.createObjectURL(valueArea.querySelector("#image").files[0]);
                    await loadImage(img);
                    var options = {
                        align: valueArea.querySelector("#align").value,
                        width: valueArea.querySelector("#width").value,
                        height: valueArea.querySelector("#height").value,
                        image: img
                    };
                    field = new ImageField(options);
                    fieldTemplate.options = options;
                    break;
                case "indent":
                    var options = {
                        indent: valueArea.querySelector("#indent").value
                    };
                    field = new IndentField(options);
                    fieldTemplate.options = options;
                    break;
                case "line":
                    var options ={
                        symbol: valueArea.querySelector("#symbol").value
                    };
                    field = new LineField(options);
                    fieldTemplate.options = options;
                    break;
                case "table":
                    var showBorder = valueArea.querySelector("#showBorder").checked;
                    var fontSize = valueArea.querySelector("#fontSize").value;
                    var headers = [];
                    var rows = [];

                    var headersDiv = valueArea.querySelectorAll("#headerColumn");
                    for (let i = 0; i < headersDiv.length; i++) {
                        const headerDiv = headersDiv[i];
                        headers.push({
                            name: headerDiv.querySelector("#columnName").value,
                            width: headerDiv.querySelector("#columnWidth").value
                        });
                    }
                    var rowsDiv = valueArea.querySelectorAll("#row");
                    for (let i = 0; i < rowsDiv.length; i++) {
                        const rowDiv = rowsDiv[i];
                        var columns = rowDiv.querySelectorAll("#column");
                        var row = []
                        for (let j = 0; j < columns.length; j++) {
                            const columnDiv = columns[j];
                            row.push({
                                value: columnDiv.querySelector("#columnValue").value,
                                width: columnDiv.querySelector("#columnWidth").value,
                                align: columnDiv.querySelector("#columnAlign").value,
                            });
                        }
                        rows.push(row);
                    }
                    var options = {
                        fontSize: fontSize,
                        showBorder: showBorder,
                        headers: headers,
                        rows: rows
                    };
                    field = new TableField(options);
                    fieldTemplate.options = options;

                    break;

            }
            template.push(fieldTemplate);
            prevYPos = field.DrawFileld(canvas, prevYPos);
        }
        console.log(JSON.stringify(template));
    }
    function RemoveLabel() {
        var label = event.target.closest("#label");
        label.remove();
        CheckUpDown();
        RedrawReciept();
    }
    var stringToHTML = function (str) {
        var dom = document.createElement('div');
        dom.innerHTML = str;
        return dom;
    };
    loadImage = async img => {
        return new Promise((resolve, reject) => {
            img.onload = async () => {
                console.log("Image Loaded");
                resolve(true);
            };
        });
    };

</script>
<script>
    dragElement(document.getElementById("dragable"));

    function dragElement(elmnt) {
        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
        if (document.getElementById(elmnt.id + "header")) {
            document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
        } else {
            elmnt.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }
</script>
<script>

</script>

</html>